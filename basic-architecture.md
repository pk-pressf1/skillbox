# Базовая архитектура

## Архитектурный стиль: Event-Driven Microservices с Domain-Driven Design (DDD)
Система построена на основе событийно-ориентированной микросервисной архитектуры, где каждый сервис представляет собой ограниченный контекст (bounded context) и взаимодействует с другими преимущественно асинхронно через Kafka. 
Это не просто технический выбор — он напрямую вытекает из требований к масштабируемости, гибкости и реактивности платформы.

### Сравнение архитектурных стилей

| Стиль                        | Почему не подходит                                                                                                                                                         | Почему выбрано текущее решение                                                                                     |
|------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------------------------------------------------------------------------|
| **Монолит**                  | Невозможно масштабировать отдельные функции (например, соц. граф при пике челленджа); команды мешают друг другу; сложна multi-cloud стратегия.                             | **Microservices** позволяют независимо развивать Auth, Social, Activity и т.д.                                     |
| **REST-based Microservices** | Цепочки синхронных вызовов (например, тренировка → геймификация → промо) создают узкие места и каскадные сбои.                                                             | **Event-driven** обеспечивает устойчивость: даже если Promo Service упал, событие сохранится и обработается позже. |
| **Serverless (FaaS)**        | Cold starts недопустимы для latency-sensitive операций; vendor lock-in противоречит multi-cloud политике; сложно управлять stateful-логикой (например, сессии тренировок). | **Kubernetes + Kafka** дают контроль, предсказуемость и переносимость.                                             |

**Итог: Event-Driven Microservices — единственный стиль, который одновременно поддерживает пиковую нагрузку, реактивную бизнес-логику, гибкость команд и стратегическую независимость от облаков.**


### Основные принципы:

- **Событийно-ориентированная модель (Kafka)** как backbone
- **Domain-Driven Design**: каждый сервис — отдельный bounded context
- **Zero Trust Security**: каждый запрос проверяется, данные сегментированы
- **Observability by design**: все компоненты инструментированы (OpenTelemetry)
- **Mobile-first + offline-first**: данные тренировок синхронизируются асинхронно

## Обоснование выбора ключевых технологий

### Хранилища данных

| Требование                                | Альтернатива                            | Выбрано        | Почему                                                                                                 |
|-------------------------------------------|-----------------------------------------|----------------|--------------------------------------------------------------------------------------------------------|
| Хранение профилей, инвентаря, согласий    | MongoDB, DynamoDB                       | **PostgreSQL** | Нужны ACID-транзакции (например, обновление износа обуви), строгая схема, поддержка JSONB для гибкости |
| Социальные связи, поиск по интересам      | PostgreSQL (рекурсивные CTE), Cassandra | **Neo4j**      | Графовые запросы («найти друзей друзей, бегающих по утрам») выполняются в разы быстрее и выразительнее |
| Аналитика активности, сравнение, рейтинги | PostgreSQL                              | **ClickHouse** | Колоночное хранение + векторизованные вычисления → агрегация 10 млн тренировок за секунды              |

### Фронтенд (клиент)

| Вариант                                             | Почему не выбрано                                                                                       | Почему выбрано                                                                                                         |
|-----------------------------------------------------|---------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------|
| Веб-приложение (PWA)                                | Нет доступа к GPS/ЧСС в фоне; ограничения безопасности; низкая вовлечённость                            | **Нативные мобильные приложения (iOS/Android)** — полный доступ к датчикам, push-уведомления, оффлайн-режим, лучший UX |
| Кроссплатформенный фреймворк (Flutter/React Native) | Риск снижения производительности при работе с GPS и BLE; сложность интеграции с нативными SDK wearables | **Нативная разработка** — максимальная надёжность и производительность для core-сценариев (трекинг, синхронизация)     |

### Инфраструктура и оркестрация

| Компонент   | Альтернатива            | Выбрано                           | Обоснование                                                                         |
|-------------|-------------------------|-----------------------------------|-------------------------------------------------------------------------------------|
| Оркестрация | Docker Swarm, Nomad     | **Kubernetes**                    | Стандарт де-факто, богатая экосистема, поддержка multi-cloud                        |
| CI/CD       | Jenkins, GitHub Actions | **GitOps (ArgoCD + Tekton)**      | Декларативность, аудит изменений, безопасность, соответствие enterprise-требованиям |
| Мониторинг  | Datadog, New Relic      | **OpenTelemetry + Grafana Stack** | Открытый стек, избегание vendor lock-in, полный контроль над данными                |


## Как архитектура закрывает ключевые требования:

- **Социальные группы** → Social Graph Service + Neo4j
- **Сравнение с собой/регионом** → Activity Tracking + аналитика в ClickHouse
- **Инвентарь и рекомендации** → User & Profile + Commerce Adapter
- **Геймификация и промо** → Gamification + Promo Service (управляемые конфигурацией)
- **Приватность** → Auth & Privacy Core с granular consent
- **Масштабируемость** → горизонтальное масштабирование сервисов, партиционирование Kafka
- **Надёжность** → multi-AZ развёртывание, RTO/RPO как SLO

---

**Такой подход обеспечивает техническую устойчивость, бизнес-гибкость и соответствие стратегическим целям компании — от глобального масштабирования до этичного обращения с данными пользователей.**